local M = {}

-- 创建 React 函数组件
function M.create_component()
  local component_name = vim.fn.input("Component name: ")
  if component_name == "" then
    return
  end

  local template = string.format([[
import React from 'react';

interface %sProps {
  // Props interface here
}

const %s: React.FC<%sProps> = ({}) => {
  return (
    <div>
      <h1>%s Component</h1>
    </div>
  );
};

export default %s;
]], component_name, component_name, component_name, component_name, component_name)

  local lines = vim.split(template, '\n')
  vim.api.nvim_put(lines, 'l', true, true)
end

-- 插入 React Hook 导入
function M.insert_hook_import()
  local hooks = {
    "useState",
    "useEffect", 
    "useContext",
    "useReducer",
    "useMemo",
    "useCallback",
    "useRef",
    "useImperativeHandle",
    "useLayoutEffect",
    "useDebugValue"
  }

  local selected_hooks = {}
  for _, hook in ipairs(hooks) do
    local choice = vim.fn.confirm("Include " .. hook .. "?", "&Yes\n&No", 1)
    if choice == 1 then
      table.insert(selected_hooks, hook)
    end
  end

  if #selected_hooks > 0 then
    local import_line = "import React, { " .. table.concat(selected_hooks, ", ") .. " } from 'react';"
    vim.api.nvim_put({import_line}, 'l', false, true)
  end
end

-- 用 JSX 标签包围选中的文本
function M.wrap_with_tag()
  local tag_name = vim.fn.input("Tag name: ")
  if tag_name == "" then
    tag_name = "div"
  end

  -- Get visual selection
  local start_pos = vim.fn.getpos("'<")
  local end_pos = vim.fn.getpos("'>")
  
  -- Insert closing tag after selection
  vim.api.nvim_buf_set_text(0, end_pos[2] - 1, end_pos[3], end_pos[2] - 1, end_pos[3], {"</" .. tag_name .. ">"})
  
  -- Insert opening tag before selection
  vim.api.nvim_buf_set_text(0, start_pos[2] - 1, start_pos[3] - 1, start_pos[2] - 1, start_pos[3] - 1, {"<" .. tag_name .. ">"})
end

-- 插入 useState Hook
function M.insert_use_state()
  local state_name = vim.fn.input("State variable name: ")
  if state_name == "" then
    return
  end
  
  local setter_name = "set" .. state_name:sub(1,1):upper() .. state_name:sub(2)
  local initial_value = vim.fn.input("Initial value: ")
  if initial_value == "" then
    initial_value = "''"
  end
  
  local use_state_line = string.format("const [%s, %s] = useState(%s);", state_name, setter_name, initial_value)
  vim.api.nvim_put({use_state_line}, 'l', true, true)
end

-- 插入 useEffect Hook
function M.insert_use_effect()
  local dependency_array = vim.fn.input("Dependencies (comma-separated): ")
  local deps = ""
  if dependency_array ~= "" then
    local dep_list = vim.split(dependency_array, ",")
    for i, dep in ipairs(dep_list) do
      dep_list[i] = dep:match("^%s*(.-)%s*$") -- trim whitespace
    end
    deps = "[" .. table.concat(dep_list, ", ") .. "]"
  else
    deps = "[]"
  end

  local use_effect_template = {
    "useEffect(() => {",
    "  // Effect logic here",
    "  ",
    "  return () => {",
    "    // Cleanup logic here",
    "  };",
    "}, " .. deps .. ");"
  }
  
  vim.api.nvim_put(use_effect_template, 'l', true, true)
end

-- 创建 React 测试文件
function M.create_test_file()
  local component_name = vim.fn.input("Component name to test: ")
  if component_name == "" then
    return
  end

  local test_template = string.format([[
import { render, screen } from '@testing-library/react';
import %s from './%s';

describe('%s', () => {
  it('renders without crashing', () => {
    render(<%s />);
  });

  it('displays correct content', () => {
    render(<%s />);
    // Add your test assertions here
  });
});
]], component_name, component_name, component_name, component_name, component_name)

  local lines = vim.split(test_template, '\n')
  vim.api.nvim_put(lines, 'l', true, true)
end

-- 快速添加 prop types
function M.add_prop_types()
  local prop_name = vim.fn.input("Prop name: ")
  if prop_name == "" then
    return
  end

  local prop_types = {
    "string",
    "number", 
    "boolean",
    "object",
    "array",
    "function",
    "node",
    "element",
    "any"
  }

  local choices = {}
  for i, ptype in ipairs(prop_types) do
    table.insert(choices, i .. ". " .. ptype)
  end
  
  local choice = vim.fn.inputlist(vim.list_extend({"Select prop type:"}, choices))
  if choice > 0 and choice <= #prop_types then
    local selected_type = prop_types[choice]
    local prop_line = string.format("%s: %s;", prop_name, selected_type)
    vim.api.nvim_put({prop_line}, 'l', true, true)
  end
end

-- 生成 React 组件的样板文件结构
function M.create_component_structure()
  local component_name = vim.fn.input("Component name: ")
  if component_name == "" then
    return
  end

  local current_dir = vim.fn.expand('%:p:h')
  local component_dir = current_dir .. "/" .. component_name

  -- 创建组件目录
  vim.fn.mkdir(component_dir, "p")

  -- 创建主组件文件
  local component_file = component_dir .. "/index.tsx"
  local style_file = component_dir .. "/styles.module.css"
  local test_file = component_dir .. "/" .. component_name .. ".test.tsx"

  -- 组件内容
  local component_content = string.format([[
import React from 'react';
import styles from './styles.module.css';

interface %sProps {
  className?: string;
}

const %s: React.FC<%sProps> = ({ className }) => {
  return (
    <div className={`${styles.container} ${className || ''}`}>
      <h1>%s Component</h1>
    </div>
  );
};

export default %s;
]], component_name, component_name, component_name, component_name, component_name)

  -- CSS 样式内容
  local style_content = [[
.container {
  /* Add your styles here */
}
]]

  -- 测试文件内容
  local test_content = string.format([[
import { render, screen } from '@testing-library/react';
import %s from './index';

describe('%s', () => {
  it('renders without crashing', () => {
    render(<%s />);
  });
});
]], component_name, component_name, component_name)

  -- 写入文件
  vim.fn.writefile(vim.split(component_content, '\n'), component_file)
  vim.fn.writefile(vim.split(style_content, '\n'), style_file)
  vim.fn.writefile(vim.split(test_content, '\n'), test_file)

  print("Created component structure for " .. component_name)
  print("Files created:")
  print("  - " .. component_file)
  print("  - " .. style_file)  
  print("  - " .. test_file)
end

return M
